# 简谱源码编写说明

## 📖 快速入门

简谱源码采用纯文本格式，遵循中国简谱记谱法的标准，易读易写。只需三步即可创建你的第一首曲谱！

### 第一步：编写元信息

在文档开头添加曲谱的基本信息（可选）：

```
标题: 小星星
作曲: 莫扎特
拍号: 4/4
速度: 120
调号: C
```

### 第二步：输入音符

每个音符用数字 `1-7` 表示（对应 do re mi fa sol la si）：

```
1 1 5 5 | 6 6 5 - |
```

### 第三步：添加节奏

使用下划线表示减时（加快节奏）：

```
1 1 5_5 6_6 | 5 - - - |
```

---

## 🎵 完整语法规则

### 1. 元信息（Metadata）

元信息写在文档开头，使用 `键: 值` 格式，支持中英文键名：

| 中文键 | 英文键 | 示例 | 说明 |
|--------|--------|------|------|
| 标题 | title | `标题: 欢乐颂` | 曲谱名称 |
| 作曲 | composer | `composer: Beethoven` | 作曲者 |
| 作词 | lyricist | `作词: 席勒` | 作词者 |
| 拍号 | time | `time: 4/4` | 拍号 |
| 速度 | tempo | `tempo: 120` | 每分钟拍数（BPM） |
| 调号 | key | `key: C` | 调号 |

**示例**：

```
标题: 小星星
composer: Mozart
拍号: 4/4
速度: 100
调号: C

1 1 5 5 | 6 6 5 - |
```

---

### 2. 音符（Note）

使用数字 `1-7` 表示七个基本音级：

| 数字 | 唱名 | 音名 | 说明 |
|------|------|------|------|
| `1` | do | C | 主音 |
| `2` | re | D | 上主音 |
| `3` | mi | E | 中音 |
| `4` | fa | F | 下属音 |
| `5` | sol | G | 属音 |
| `6` | la | A | 下中音 |
| `7` | si | B | 导音 |

**示例**：

```
1 2 3 4 5 6 7 1
```

---

### 3. 高低八度（Octave）

使用 `'` 和 `.` 标记音符的八度：

| 符号 | 说明 | 示例 | 效果 |
|------|------|------|------|
| `'` | 高八度（前置） | `'1` | 高一个八度的 do |
| `''` | 高两个八度（前置） | `''1` | 高两个八度的 do |
| `.` | 低八度（前置） | `.1` | 低一个八度的 do |
| `..` | 低两个八度（前置） | `..1` | 低两个八度的 do |

**示例**:

**示例**:

```
..5 .5 .6 .7 1 2 3 4 5 6 7 '1 '2 '3 ''1 ''2
```

**说明**：
- `..1` = 低两个八度的 do
- `.1` = 低一个八度的 do  
- `1` = 标准八度的 do
- `'1` = 高一个八度的 do
- `''1` = 高两个八度的 do

---

### 4. 变音记号（Accidental）

使用 `#` 和 `b` 表示升降号：

| 符号 | 说明 | 位置 | 示例 | 效果 |
|------|------|------|------|------|
| `#` | 升号 | 音符前 | `#4` | 升 fa (#F) |
| `b` | 降号 | 音符前 | `b7` | 降 si (♭B) |

**示例**：

```
1 2 3 #4 5 6 #6 7
```

**注意**：升降号写在音符**前面**。

---

### 5. 附点（Dot Notation）

使用 `.` 表示附点（延长 50% 时值）：

| 符号 | 说明 | 位置 | 示例 | 效果 |
|------|------|------|------|------|
| `.` | 附点 | 音符后 | `1.` | 附点四分音符 |

**⚠️ 重要提示**：为避免与低八度符号混淆，**请使用下划线表示时值**。

---

### 6. 时值（Duration）

#### 减时线（Underline）

使用下划线 `_` 减少音符时值（每个下划线减半）：

| 符号 | 时值 | 说明 | 示例 |
|------|------|------|------|
| 无 | 1 拍 | 四分音符 | `1` |
| `_` | 0.5 拍 | 八分音符 | `1_` |
| `__` | 0.25 拍 | 十六分音符 | `1__` |
| `___` | 0.125 拍 | 三十二分音符 | `1___` |

**示例**：

```
1 2 3_3 4__4__5__5__ | 6 - - - |
```

#### 延长线（Tie）

使用 `-` 延长前一个音符 1 拍（相当于增加一个四分音符时值）：

| 符号 | 时值 | 说明 | 示例 |
|------|------|------|------|
| `-` | +1 拍 | 延长线 | `1 -` = 2 拍 |
| `- -` | +2 拍 | 两个延长线 | `1 - -` = 3 拍 |
| `- - -` | +3 拍 | 三个延长线 | `1 - - -` = 4 拍 |

**示例**：

```
1 - - - | 5 - 3 - | 1 - - - |
```

---

### 7. 休止符（Rest）

使用 `0` 表示休止符（静音）：

| 符号 | 说明 | 示例 | 效果 |
|------|------|------|------|
| `0` | 四分休止符 | `1 0 2 0` | 1 拍休止 |
| `0_` | 八分休止符 | `1 0_ 2` | 0.5 拍休止 |
| `0 -` | 二分休止符 | `1 0 - 2` | 2 拍休止 |

**示例**：

```
1 2 3 0 | 5 0 0 0 | 1 - - - |
```

---

### 9. 倚音（Grace Note / Appoggiatura）

使用 `^` 前缀标记倚音（装饰音）：

```
^4 5 ^6 7 | ^'1 2 ^3 4 |
```

**视觉效果**：倚音显示为小号字体，位于主音符的左上方。

**专业特性**：
- 倚音**不占用独立的节拍时间**，从主音符中“借用”时间
- 因此 `^4 5 6 7` 在 4/4 拍中正好是 4 拍（5、6、7 各 1 拍，4 是装饰音）
- 播放时倚音在主音符之前极短时间（~50ms）发声
- 倚音可以有八度标记：`^'1` `^.7`
- 倚音可以有升降号：`^#4` `^b7`
- 连续倚音：`^3^4 5`（两个倚音，主音是5）

**示例**：

```
标题: 倚音示例
调号: C
拍号: 4/4

^4 5 ^6 5 | ^'1 7 6 5 | ^3 4 ^2 3 | ^5 1 - - |
```

每小节分析（倚音不计入节拍）：
- 小节 1: 5(1拍) + 5(1拍) = 2拍 → **不符合 4/4，需要 4 拍**
- 小节 2: 7(1拍) + 6(1拍) + 5(1拍) = 3拍 → **不符合 4/4，需要 4 拍**
- 小节 3: 4(1拍) + 3(1拍) = 2拍 → **不符合 4/4，需要 4 拍**
- 小节 4: 1(1拍) + -(1拍) + -(1拍) = 3拍 → **不符合 4/4，需要 4 拍**

正确的示例应为：

```
标题: 倚音示例
调号: C
拍号: 4/4

^4 5 - ^6 5 | ^'1 7 - 6 5 | ^3 4 - ^2 3 | ^5 1 - - - |
```

---

### 10. 小节线（Barline）

使用 `|` 分隔小节：

```
1 2 3 4 | 5 6 7 1' | 1' 0 0 0 |
```

**规则**：
- 每个小节线前后可以有空格，也可以没有
- 小节内音符用空格分隔
- 可以在行末省略小节线

---

### 11. 连音线（Beam）

**八分音符连线**：通过**空格控制**分组，无空格的相邻八分音符会自动用横线连接。

| 源码 | 视觉效果 | 说明 |
|------|----------|------|
| `1_ 2_` | 各自独立减时线 | 有空格，分开 |
| `1_2_` | 一条横线连接 | 无空格，连接 |
| `1_2_ 3_4_` | 两条独立横线 | 2+2分组 |
| `1_2_3_4_` | 一条横线连接全部 | 4个全连 |

**示例**：

```
1_2_3_4_ 5_ | 6_7_ 1'_2'_ |
```

**规则**：
- 只有相同时值的音符才能连接（八分+八分，十六分+十六分）
- 小节线 `|` 自动断开连音组
- 空格是分组的唯一控制手段

---

### 12. 圆滑线（Slur）

**语法**：使用小括号 `()` 标记圆滑演奏的音符组。

```
(1 2 3) 4 | (5 6 7) 1' |
```

**视觉效果**：括号内的音符上方会显示弯曲的弧线连接。

**与其他连线的区别**：

| 类型 | 音高关系 | 语法 | 视觉 | 用途 |
|------|----------|------|------|------|
| **延音线**（Tie） | 相同 | `1 -` | 水平直线 | 延长音符时值 |
| **连音线**（Beam） | 任意 | `1_2_` | 音符间横线 | 八分音符分组 |
| **圆滑线**（Slur） | 不同 | `(1 2 3)` | 弧形曲线 | 连贯演奏 |

**特性**：
- ✅ **跨小节支持**：`(1 2 | 3 4)` 可跨越小节线
- ✅ **动态高亮**：播放时，圆滑线会根据音符状态变色
- ✅ **灵活分组**：一行内可有多个圆滑线组

**示例**：

```
标题: 圆滑线示例
调号: C
拍号: 4/4

(1 2 3) 4 | (5 6 | 7 '1) '2 | ('3_ '3_ '2 '1) 7 | '1 - - - |
```

**注意**：
- 圆滑线内必须至少包含2个音符
- 括号必须成对出现
- 暂不支持嵌套圆滑线

---

## 💡 实用示例

### 示例 1：小星星（简单版）

```
标题: 小星星
拍号: 4/4
速度: 80

1 1 5 5 | 6 6 5 - |
4 4 3 3 | 2 2 1 - |
5 5 4 4 | 3 3 2 - |
5 5 4 4 | 3 3 2 - |
1 1 5 5 | 6 6 5 - |
4 4 3 3 | 2 2 1 - |
```

### 示例 2：生日快乐（带减时线）

```
标题: 生日快乐
拍号: 3/4
速度: 100

5 5 | 6 5 1' 7 | 5 5 6 5 2' 1' |
5 5 5' 3' 1' 7 6 | 4' 4' 3' 1' 2' 1' |
```

### 示例 3：欢乐颂（带高低八度）

```
标题: 欢乐颂
composer: Beethoven
拍号: 4/4
速度: 120

3 3 4 5 | 5 4 3 2 |
1 1 2 3 | 3 2 2 - |
3 3 4 5 | 5 4 3 2 |
1 1 2 3 | 2 1 1 - |
```

### 示例 4：复杂节奏（带减时线和延长线）

```
标题: 节奏练习
拍号: 4/4
速度: 100

1_2_3_4_ | 5 - 3 - |
1__1__2__2__ | 3_3_4_4_ |
5 - - - | 1' 0 0 0 |
```

---

## 🔍 常见问题

### Q1: 如何区分低八度的 `.` 和附点的 `.`？

**A**: 根据上下文判断：
- 如果 `.` 在音符后面，且该音符不在行首，通常是**低八度**
- 如果需要附点，建议使用**下划线**表示时值（例如 `1 -` 代替 `1.`）

**示例**：
```
1. 1 1' 1   # 1. 是低八度，1' 是高八度
1_ 2_ 3 4   # 1_ 和 2_ 是八分音符
```

### Q2: 下划线可以连续使用吗？

**A**: 可以。每个下划线减半时值：
```
1       # 1 拍（四分音符）
1_      # 0.5 拍（八分音符）
1__     # 0.25 拍（十六分音符）
1___    # 0.125 拍（三十二分音符）
```

### Q3: 延长线 `-` 可以连续使用吗？

**A**: 可以。每个 `-` 延长 1 拍：
```
1 -         # 2 拍（二分音符）
1 - -       # 3 拍（附点二分音符）
1 - - -     # 4 拍（全音符）
```

### Q4: 升降号可以和八度符号一起用吗？

**A**: 可以。升降号在前，八度符号在后：
```
#4 #4' b7.   # 升 fa、高八度的升 fa、低八度的降 si
```

### Q5: 小节线是必须的吗？

**A**: 不是必须的，但强烈建议使用小节线，便于阅读和理解节奏。

### Q6: 空格有什么要求？

**A**: 空格用于分隔音符，数量不限。**特别注意**：对于八分音符（`1_`），空格还控制连音线分组：
```
1_ 2_     # 有空格，各自独立
1_2_      # 无空格，用横线连接
```

### Q7: 如何表示相同音高的延音线？

**A**: 使用 `-` 延长线：
```
1 - - -   # do 持续 4 拍（等同于全音符）
5 -       # sol 持续 2 拍（等同于二分音符）
```

### Q8: 如何表示不同音高的圆滑线（连线记号）？

**A**: 当前版本暂不支持不同音高的圆滑线渲染。系统主要用于简谱记录和播放，圆滑线属于演奏技法标记，对音高和节奏无影响。未来版本可能添加括号语法 `(1 2 3)` 支持。

---

## ⚡ 快捷输入技巧

### 技巧 1：使用空格对齐

```
1   2   3   4   |   # 每个音符用 3 个空格对齐
5   6   7   1'  |
```

### 技巧 2：小节内分组

```
1 2 | 3 4 | 5 6 | 7 1' |   # 清晰的分组
```

### 技巧 3：复制粘贴重复段落

如果有重复的乐句，可以直接复制粘贴：

```
1 1 5 5 | 6 6 5 - |   # A 段
4 4 3 3 | 2 2 1 - |
1 1 5 5 | 6 6 5 - |   # A 段重复（复制粘贴）
4 4 3 3 | 2 2 1 - |
```

---

## 🎓 学习路径

### 第一阶段：基础音符
1. 尝试输入 `1 2 3 4 5 6 7 1'`
2. 点击播放，听听音高变化

### 第二阶段：简单旋律
1. 输入《小星星》前 4 小节
2. 调整速度，找到合适的节奏

### 第三阶段：节奏变化
1. 尝试使用下划线 `_` 创建八分音符
2. 使用延长线 `-` 创建长音

### 第四阶段：复杂乐曲
1. 添加升降号和八度标记
2. 完整输入一首歌曲

---

## 📚 参考资料

### 简谱基础知识
- [简谱 - 维基百科](https://zh.wikipedia.org/wiki/简谱)
- [中国简谱记谱法](https://baike.baidu.com/item/简谱)

### 音乐理论
- 音程：两个音之间的距离
- 节奏：音符的长短组合
- 拍号：每小节的拍数和单位拍的时值

---

## 🛠️ 调试技巧

### 解析错误

如果输入后没有显示曲谱，检查：

1. **元信息格式**：确保使用 `键: 值` 格式
2. **音符有效性**：只使用 `0-7`、`#`、`b`、`'`、`.`、`_`、`-`、`|`
3. **空格分隔**：音符之间需要空格
4. **小节线**：确保小节线 `|` 独立或两侧有空格

### 播放问题

如果无法播放：

1. **检查浏览器**：确保使用现代浏览器（Chrome、Firefox、Safari、Edge）
2. **音量设置**：检查系统音量和浏览器音量
3. **音符错误**：确保所有音符都有正确的时值

---

## 💬 获取帮助

- **GitHub Issues**: [as-nmn/issues](https://github.com/your-org/as-nmn/issues)
- **示例曲谱**: 点击「加载示例」按钮查看完整示例
- **文档**: 查看项目 README 和技术文档

---

**文档版本**: v1.0  
**更新日期**: 2026年2月7日  
**作者**: as-nmn 产品团队
