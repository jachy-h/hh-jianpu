# 图片识别转简谱 — 开发 TODO List

**版本**: v0.2.0  
**创建日期**: 2026年2月8日  
**前置文档**: 
- 产品设计: `docs/production/03-image-recognition-product-design.md`
- 架构设计: `docs/architecture/02-image-recognition-architecture.md`

---

## 开发顺序说明

按依赖关系分为 5 个阶段，严格按顺序执行。每个任务标注预估工时和验收标准。

---

## Phase 0: 准备工作（0.5 天）

- [ ] **T0.1** 阅读并理解产品设计文档和架构设计文档
- [ ] **T0.2** 创建开发分支 `feat/image-recognition`
- [ ] **T0.3** 创建目录结构（不写代码，先搭骨架）
  ```
  apps/web/src/services/ocr/
  apps/web/src/components/ImageImport/
  apps/web/src/components/Settings/
  ```
- [ ] **T0.4** 确认 OpenAI / Anthropic API 的 CORS 策略，如果有限制记录解决方案

**验收**: 目录已创建，CORS 调研结论已记录

---

## Phase 1: OCR 服务层（2 天）

### 类型定义

- [ ] **T1.1** 编写 `services/ocr/types.ts`
  - 定义 `OCRStatus`, `OCRResult`, `OCRError`, `LLMProviderConfig`, `ImportMode`
  - 定义 `PreprocessOptions`, `PreprocessResult`
  - **验收**: 类型编译通过，无 `any`

### 图片预处理

- [ ] **T1.2** 编写 `services/ocr/preprocessor.ts`
  - 实现 `validateImage(file: File)` — 校验文件类型和大小
  - 实现 `preprocessImage(file: File, options?)` — Canvas 缩放 + Base64 导出
  - **验收**: 
    - 10MB 以上文件被拒绝
    - 4096px 图片被缩放至 2048px
    - 输出正确的 Base64 字符串
  - **测试**: 编写 ≥3 个单元测试（正常图片、超大图片、无效格式）

### LLM 客户端

- [ ] **T1.3** 编写 `services/ocr/llm-client.ts`
  - 实现 `createLLMClient(config: LLMProviderConfig)` — 工厂函数
  - 实现 OpenAI 兼容调用（`/v1/chat/completions` with image_url）
  - 实现 Anthropic 调用（`/v1/messages` with image media_type）
  - 实现 30s 超时（AbortController）
  - **验收**: 
    - OpenAI 格式请求构造正确
    - Anthropic 格式请求构造正确
    - 超时后正确抛出错误
  - **测试**: 编写 ≥3 个单元测试（mock fetch，验证请求格式和错误处理）

### Prompt 定义

- [ ] **T1.4** 编写识别 Prompt
  - 在 `llm-client.ts` 中定义 `RECOGNITION_PROMPT` 常量
  - 内容参考架构设计文档中的 Prompt 设计
  - Prompt 需明确输出 hh-jianpu 语法格式
  - **验收**: Prompt 中包含完整的语法规则说明

### 后处理

- [ ] **T1.5** 编写 `services/ocr/postprocessor.ts`
  - 实现 `postprocess(rawText: string)` — 清洗 LLM 输出
  - 去除 markdown 代码块标记（\`\`\`）
  - 去除解释性文字（只保留简谱内容）
  - 规范化空格和换行
  - 尝试调用 `parse()` 验证语法
  - **验收**:
    - 能处理带 ``` 包裹的输出
    - 能处理 LLM 输出中的额外解释文字
    - 输出可被 Parser 成功解析
  - **测试**: 编写 ≥4 个单元测试（正常输出、带 markdown 标记、带解释文字、空输出）

### API Key 管理

- [ ] **T1.6** 编写 `services/ocr/config.ts`
  - 实现 `saveLLMConfig`, `loadLLMConfig`, `clearLLMConfig`
  - 实现 `testLLMConnection(config)` — 发送简单请求验证 Key 可用性
  - **验收**: localStorage 读写正确，异常输入不崩溃
  - **测试**: 编写 ≥2 个单元测试

### 统一入口

- [ ] **T1.7** 编写 `services/ocr/ocr-service.ts`
  - 实现 `recognizeImage(file: File, config: LLMProviderConfig)` — 串联 1→2→3 阶段
  - 返回 `Promise<OCRResult>`，统一错误处理
  - 提供 `onProgress` 回调（报告当前阶段）
  - **验收**: 完整流程可运行（使用 mock）
  - **测试**: 编写 ≥2 个集成测试（mock LLM，验证端到端流程）

- [ ] **T1.8** 编写 `services/ocr/index.ts`
  - 聚合导出

---

## Phase 2: 状态管理扩展（0.5 天）

- [ ] **T2.1** 扩展 `useStore.ts`
  - 新增状态字段: `ocrStatus`, `ocrResult`, `ocrError`
  - 新增方法: `recognizeImage(file)`, `applyOCRResult(mode)`, `clearOCRState()`
  - `applyOCRResult` 内部调用 `setSourceImmediate`
  - **验收**: 
    - 现有 25 个测试全部通过（无回归）
    - 新增方法类型正确
  - **回归测试**: 运行 `pnpm test` 确认现有测试不受影响

---

## Phase 3: UI 组件（2 天）

### 设置面板

- [ ] **T3.1** 编写 `components/Settings/SettingsModal.tsx`
  - 服务商下拉选择（OpenAI / Anthropic / 兼容 API）
  - API Key 输入框（密码模式，带显示/隐藏切换）
  - 自定义 Base URL 输入（兼容 API 时显示）
  - 测试连接按钮
  - 保存/取消按钮
  - **验收**: 
    - Key 保存到 localStorage
    - 测试连接有反馈
    - 响应式设计（移动端可用）

- [ ] **T3.2** 编写 `components/Settings/index.ts`

### 图片导入按钮

- [ ] **T3.3** 编写 `components/ImageImport/ImageImportButton.tsx`
  - 📷 图标 + "识别图片" 文字
  - 无 API Key 时: 禁用状态 + hover 提示 "需要先配置 API Key"
  - 有 API Key 时: 正常可点击
  - 仅在编辑模式下渲染
  - **验收**: 按钮状态随 API Key 配置变化

### 图片预览

- [ ] **T3.4** 编写 `components/ImageImport/ImagePreview.tsx`
  - 显示上传图片的缩略图
  - 显示图片尺寸信息
  - 支持移除重选
  - **验收**: 图片正常显示和移除

### 图片导入面板

- [ ] **T3.5** 编写 `components/ImageImport/ImageImportModal.tsx`
  - 拖拽上传区域（drag & drop）
  - 文件选择器（input type=file）
  - 图片预览（引用 ImagePreview）
  - 识别中状态（进度提示）
  - 开始识别 / 取消按钮
  - **验收**:
    - 拖拽和点击上传都正常
    - 识别中显示加载状态
    - 取消可中断识别

### 识别结果展示

- [ ] **T3.6** 编写 `components/ImageImport/RecognitionResult.tsx`
  - 展示识别出的简谱源码（只读文本框）
  - 显示警告信息（如有 `?` 标记）
  - 三个操作按钮: [替换内容] [追加到末尾] [取消]
  - **验收**:
    - 源码正确展示
    - 替换/追加功能正常
    - 操作后面板关闭

- [ ] **T3.7** 编写 `components/ImageImport/index.ts`

### 粘贴图片检测

- [ ] **T3.8** 在 Editor 组件中添加粘贴图片检测
  - 监听 `paste` 事件
  - 检测 `clipboardData` 中是否包含图片
  - 触发提示条（非模态框）
  - **验收**:
    - 粘贴文字: 正常行为不变
    - 粘贴图片: 显示提示条
    - 提示条 5s 后自动消失

---

## Phase 4: 集成与调试（1.5 天）

### 组件集成

- [ ] **T4.1** 修改 `App.tsx`
  - 引入 `ImageImportButton`, `ImageImportModal`, `SettingsModal`
  - 添加 `isImageImportOpen`, `isSettingsOpen` 状态
  - **验收**: 所有浮层正确打开/关闭，不影响现有功能

- [ ] **T4.2** 修改 `AppLayout.tsx`
  - 顶栏新增 ⚙️ 设置按钮（靠近帮助按钮）
  - 编辑模式区域新增 📷 识别图片按钮
  - **验收**: 按钮位置合理，视觉不突兀

### 真实 API 测试

- [ ] **T4.3** 使用真实 API Key 端到端测试
  - 准备 3 张测试图片:
    - 电子版清晰简谱（预期准确率 ≥85%）
    - 手机拍照简谱（预期准确率 ≥70%）
    - 非简谱图片（预期友好报错）
  - 记录每张图片的识别结果和耗时
  - **验收**: 3 张图片全部有合理结果

- [ ] **T4.4** 错误场景测试
  - 无效 API Key → 正确提示
  - 断网 → 正确提示
  - 超大图片 → 前端拦截
  - 超时 → 正确提示
  - **验收**: 所有错误场景有友好提示，不白屏

### 帮助文档更新

- [ ] **T4.5** 更新 `HelpModal.tsx`
  - 新增"📷 图片识别"章节
  - 说明使用步骤和注意事项
  - **验收**: 帮助文档中可查看图片识别说明

---

## Phase 5: 收尾（0.5 天）

- [ ] **T5.1** 回归测试
  - 运行 `pnpm test` — 全部通过
  - 运行 `pnpm build` — 构建成功
  - 手动测试现有功能（编辑、预览、播放）— 无影响
  - **验收**: 零回归

- [ ] **T5.2** 更新文档
  - 更新 `CHANGELOG.md`
  - 更新 `README.md`（新增图片识别功能说明）
  - **验收**: 文档与实际功能一致

- [ ] **T5.3** 代码审查
  - 检查所有新增文件是否遵循项目编码规范
  - 检查是否有 `any` 类型
  - 检查 `import` 路径是否正确
  - **验收**: 无编码规范违规

- [ ] **T5.4** 合并到主分支
  - PR 描述包含功能说明和测试截图
  - CI 通过（如已搭建）
  - **验收**: 成功合并

---

## 时间估算汇总

| 阶段 | 预估工时 | 核心交付 |
|------|---------|---------|
| Phase 0: 准备 | 0.5 天 | 目录骨架 + CORS 调研 |
| Phase 1: 服务层 | 2 天 | OCR 完整管线（预处理→LLM→后处理） |
| Phase 2: 状态管理 | 0.5 天 | Store 扩展 + 回归验证 |
| Phase 3: UI 组件 | 2 天 | 上传面板 + 设置面板 + 粘贴检测 |
| Phase 4: 集成调试 | 1.5 天 | 真实 API 测试 + 错误场景 |
| Phase 5: 收尾 | 0.5 天 | 文档 + 审查 + 合并 |
| **总计** | **7 天** | |

---

## 风险提示

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| LLM API CORS 限制 | 中 | 阻塞 | 提供可配置的 CORS 代理地址 |
| 识别准确率不达预期 | 中 | 体验差 | 优化 Prompt，引导用户上传清晰图片 |
| API 费用让用户犹豫 | 低 | 使用率低 | 说明单次调用费用（约 $0.01-0.05） |
| 安全顾虑（Key 暴露） | 低 | 信任问题 | 明确说明 Key 仅存本地 |

---

## 注意事项

1. **每完成一个 T 任务，运行 `pnpm test` 确认无回归**
2. **不修改 `packages/core/` 下的任何文件**
3. **所有新增组件使用 Tailwind CSS，遵循项目配色方案**
4. **所有新增类型使用 `interface`，避免 `any`**
5. **Prompt 文本可能需要多次迭代优化，预留调整时间**

---

**创建人**: 技术架构师  
**执行人**: 开发工程师  
**审阅人**: 产品经理
