# hh-jianpu v0.1.1 阶段性复盘

**复盘日期**: 2026年2月8日  
**参与角色**: 音乐专家 · 产品经理 · 技术架构师  
**版本范围**: v0.1.0 (MVP) → v0.1.1 (增强)

---

## 一、项目现状总览

### 已交付能力

| 能力 | 状态 | 备注 |
|------|------|------|
| 简谱文本解析（Parser） | ✅ 稳定 | 支持 1-7 音符、休止符、延长线、减时线、升降号、高低八度 |
| SVG 曲谱渲染（Renderer） | ✅ 稳定 | 自动分行、响应式布局、音符/小节线/减时线/附点完整渲染 |
| 音频播放（Player） | ✅ 稳定 | Tone.js 合成音、播放/暂停/停止、速度调节(40-240 BPM) |
| 音符高亮跟踪 | ✅ 稳定 | 播放时实时高亮当前音符 |
| 编辑模式 | ✅ 稳定 | 实时预览、300ms 防抖、可拖动面板 |
| 演奏模式 | ✅ 稳定 | 全屏曲谱 + 播放控制栏 |
| 圆滑线（Slur） | ✅ 新增 | SVG 贝塞尔曲线、跨小节、动态高亮 |
| 倚音（Grace Note） | ✅ 新增 | 长/短倚音、不占独立时间 |
| 波音（Trill） | ✅ 新增 | 单波音、复波音、下波音 |
| 换气记号（Breath） | ✅ 新增 | v 标记、不占时间 |
| 帮助文档 | ✅ 新增 | 应用内模态框 |
| 可拖动分隔线 | ✅ 新增 | 编辑模式面板宽度自由调整 |

### 质量指标

| 指标 | 数值 |
|------|------|
| 单元测试 | 25/25 通过 (100%) |
| 构建状态 | ✅ 无错误 |
| 打包体积 (gzipped) | ~135KB |
| 首屏加载 | ~1.3s |

---

## 二、音乐专家复盘

### 2.1 ✅ 做得好的部分

**语法设计直觉化**：
- `1-7` 对应 do-si 完全符合简谱直觉，初学者零门槛
- `-` 延长、`/` 减时、`|` 小节线在视觉上与纸质简谱高度一致
- `#` `b` 升降号放在音符前，符合专业简谱书写习惯

**装饰音体系完整**：
- 倚音（`^`前缀）支持长/短两种类型，覆盖实际演奏需要
- 波音（`~`前缀）区分单/复/下三种变体，专业性强
- 换气记号（`v`）虽小但对声乐/管乐练习很实用

**播放音准**：
- 十二平均律频率计算正确
- 倚音"借时间"而非"占时间"，符合乐理规范

### 2.2 ⚠️ 存在的不足

**1. 节拍验证已实现 ✅**

Parser 现已支持小节时值校验，会检查每小节的音符总时值是否符合拍号，不符合时给出友好提示。例如 `4/4` 拍小节若写了 5 个四分音符，会提示"小节 N 时值不符：期望 4 拍，实际 5.00 拍"。

**2. 连音符（Tuplet）功能待设计**

降低优先级， 在后续实现

三连音（在一拍内均匀演奏 3 个音）是简谱中非常常见的节奏型，目前不支持。

> **设计方案讨论中**：
> - 方案 A（推荐）：使用简洁分组符号 `(123)` 表示三连音，`(12345)` 表示五连音
> - 方案 B：连续三个无空格音符自动识别为三连音（存在歧义风险）
> - **建议优先级：P4**

**3. 反复记号缺失**

真实简谱中 `‖:` `:‖` 反复记号、D.C.、D.S. 极为常见，直接影响完整曲目的编写。

> **建议优先级：P2** — 在 v0.3.x 加入

**4. 多声部/和弦不支持**

尤克里里和吉他练习中和弦标记（如 C Am F G）是刚需。

> **建议优先级：P3** — MVP 阶段不做，但架构需预留

**5. 音色单一**

当前只有简单合成音，缺乏表现力。对于练习辨音来说勉强够用，但体验不佳。

> **建议优先级：P3** — 可在 v0.3.x 引入 SoundFont 或采样音色

---

## 三、产品经理复盘

### 3.1 ✅ 产品目标达成情况

**核心路径验证**：「粘贴文本 → 看到曲谱 → 按下播放跟着练」— ✅ 已完全打通

| MVP 验收标准 | 状态 |
|-------------|------|
| 支持纯文本简谱输入，自动渲染为可视化简谱 | ✅ |
| 点击播放按钮，按曲谱顺序发出对应音高的声音 | ✅ |
| 当前播放的音符有明显的高亮/指示效果 | ✅ |
| 提供 BPM/速度调节 | ✅ |
| 内置 2-3 首示例曲谱 | ✅（6首） |
| 响应式布局 | ✅ |
| 首次使用到成功播放 < 30 秒 | ✅ |

### 3.2 ⚠️ 用户体验缺口

**1. 输入门槛仍然偏高**

虽然语法直觉，但用户仍需**手动输入文本**。目标用户画像（小林，零乐理基础）从网上找的谱子大多是**图片格式**（PDF、小红书截图、贴吧图片），现在必须手动翻译成文本语法。

> **这正是下一阶段的核心痛点** — 图片识别功能可以直接解决

**2. 错误反馈不够友好**

解析错误只显示"行号 + 消息"，缺乏：
- 具体建议（如"你可能忘记了小节线"）
- 与编辑器光标的联动
- 可视化的错误位置标记

> **建议优先级：P1** — 在编辑器集成 CodeMirror 6 时一并改善

**3. 缺少本地存储**

用户关闭页面就丢失编辑内容，体验断裂。

> **建议优先级：P1** — localStorage 实现成本低，收益高

**4. 移动端编辑体验差**

移动端文本编辑区体验不佳，键盘弹出后可用面积太小。

> **建议：移动端定位为"查看+播放"设备，编辑推荐在桌面端完成**

### 3.3 用户反馈预判

基于用户画像，用户使用的第一个卡点极可能是：
> "我有一张简谱图片，怎么变成你这个格式？"

→ 这验证了"图片识别"功能的优先级。

---

## 四、技术架构师复盘

### 4.1 ✅ 架构决策正确之处

**1. 三层解耦（Parser / Renderer / Player）**

事实证明这个分层非常正确：
- v0.1.1 新增圆滑线、倚音、波音时，只需扩展类型 + 各层独立修改
- Parser 不依赖 Renderer/Player，单元测试简洁高效
- Renderer 纯计算（无 DOM 依赖），测试易维护

**2. Monorepo 结构**

`@hh-jianpu/core` 与 `@hh-jianpu/web` 分离，为未来的 CLI 工具、VSCode 插件、其他框架集成预留了空间。

**3. SVG 渲染方案**

SVG 在简谱场景下表现优异：
- 元素可交互（未来支持点击音符播放）
- 分辨率无关（无 Canvas 的模糊问题）
- 圆滑线用贝塞尔曲线自然表达

**4. Zustand 状态管理**

单 store 足以应对当前规模，代码量极小，无 Redux 式 boilerplate。

### 4.2 ⚠️ 技术债务

**1. Parser 缺乏正式的语法规范（Grammar）**

当前 Parser 是手写的递归下降，随着语法元素（圆滑线、倚音、波音）增加，parseNote 函数已经变得复杂。缺乏正式的 BNF/PEG 语法定义，新增语法元素时容易引入边界 bug。

> **建议**：在 v0.2.0 前编写正式的语法规范文档，作为 Parser 的"需求文档"

**2. 编辑器是原生 textarea**

目前没有语法高亮、自动补全、错误标注。CodeMirror 6 已在技术选型中但未集成。

> **建议优先级：P1** — v0.2.0 集成

**3. 测试覆盖面不足**

25 个测试看起来不少，但边界情况覆盖不够：
- 空输入、超大输入、格式畸形的输入未覆盖
- 圆滑线嵌套、倚音组合 + 圆滑线等组合场景未测试
- Renderer 只有 4 个测试，布局计算的精确性验证不足

> **建议**：每次新增语法元素，同步补充 ≥5 个边界测试

**4. 缺少 CI/CD**

没有 GitHub Actions，PR 无自动测试和构建验证。

> **建议优先级：P1** — 成本极低，收益大

### 4.3 架构就绪评估（新功能适配性）

| 能力 | 是否就绪 | 说明 |
|------|---------|------|
| 新增语法元素 | ✅ | Token + Parser + Types 扩展模式成熟 |
| 新增渲染元素 | ✅ | NoteView/MeasureView 组件化扩展 |
| 新增外部输入源（如图片） | ⚠️ 需设计 | 当前只有文本输入入口，需新增输入通道 |
| 新增包（如 `@hh-jianpu/ocr`） | ✅ | Monorepo 天然支持 |
| 引入后端依赖 | ⚠️ 慎重 | 当前纯前端，引入后端会改变部署模型 |

---

## 五、后续路线图

### Phase 1 — v0.2.0：降低输入门槛（下一阶段重点）

| 功能 | 优先级 | 预估工时 |
|------|--------|---------|
| **图片识别转简谱** | P0 | 5-8 天 |
| ~~小节时值校验~~ | ~~P1~~ | ~~✅ 已完成~~ |
| 本地存储 | P1 | 1 天 |
| CodeMirror 6 集成 | P1 | 2-3 天 |
| CI/CD（GitHub Actions） | P1 | 0.5 天 |

### Phase 2 — v0.3.0：编辑体验升级

| 功能 | 优先级 | 预估工时 |
|------|--------|---------|
| 语法高亮 + 错误标注 | P1 | 2 天 |
| 点击音符从该位置播放 | P1 | 1 天 |
| 选段循环播放 | P1 | 2 天 |
| 变调（移调）功能 | P2 | 1 天 |
| 三连音支持 | P2 | 2 天 |

### Phase 3 — v0.4.0：输出与分享

| 功能 | 优先级 | 预估工时 |
|------|--------|---------|
| 导出图片/PDF | P2 | 2 天 |
| 打印友好样式 | P2 | 1 天 |
| 反复记号 | P2 | 3 天 |
| PWA 离线支持 | P3 | 1 天 |

---

## 六、复盘结论

### 核心共识

1. **MVP 验证成功**：核心价值链（输入→渲染→播放→跟练）已打通，架构可靠
2. **下一步聚焦降低输入门槛**：图片识别是用户最大痛点，也是产品差异化的关键
3. **保持克制**：不加多声部、不加社区功能、不加账号体系，专注"简谱练习"场景
4. **技术债务适度清理**：CI/CD、测试覆盖、CodeMirror 在 v0.2.0 一并处理

### 行动项

- [ ] 完成图片识别功能的产品设计和架构设计（本次输出）
- [ ] 编写正式语法规范文档（BNF/PEG）
- [ ] 搭建 GitHub Actions CI
- [ ] 补充边界测试用例

---

**复盘人**: Jachy  
**下次复盘**: v0.2.0 交付后
