# 图片识别转简谱 — 产品功能设计

**版本**: v0.2.0  
**设计日期**: 2026年2月8日  
**设计原则**: 极简克制，不影响现有功能

---

## 一、需求来源

### 用户痛点

目标用户（零乐理基础的乐器初学者）获取简谱的主要途径：
1. 小红书/贴吧帖子里的图片（占 60%+）
2. PDF 文件截图（占 20%+）
3. 朋友转发的图片（占 15%）
4. 手动输入文本（占 5%）

**核心矛盾**：用户手里有的是**图片**，工具需要的是**文本**。

### 一句话需求

> 用户拍一张简谱图片或粘贴截图，系统自动识别并转换成可编辑的简谱源码。

---

## 二、功能边界（极简克制）

### ✅ 做什么

1. 支持上传本地图片（jpg/png/webp）
2. 支持粘贴剪贴板中的图片
3. 识别图片中的简谱数字和基本符号
4. 转换为 hh-jianpu 源码语法并填入编辑器
5. 用户可在编辑器中修正识别结果

### ❌ 不做什么

- ❌ 不做五线谱识别（完全不同的识别模型）
- ❌ 不做实时摄像头扫描
- ❌ 不做批量文件处理
- ❌ 不做图片存储/历史记录
- ❌ 不做识别结果的置信度标注（MVP 阶段）
- ❌ 不做手写简谱识别（仅支持印刷体/电子版）

---

## 三、交互设计

### 3.1 入口位置

在编辑模式的编辑器区域上方，新增一个不起眼的入口：

```
┌──────────────────────┬─────────────────────────────┐
│ [📷 识别图片]  编辑区  │       预览区                 │
│                      │                             │
│  标题: 小星星         │   ♩ 小星星                   │
│  调号: C             │   1=C  4/4  ♩=120           │
│  ...                 │   ...                       │
└──────────────────────┴─────────────────────────────┘
```

**设计理由**：
- 入口放在编辑区顶部（而非全局顶栏），因为这是"输入方式之一"
- 使用图标 + 简短文字，不喧宾夺主
- 只在编辑模式下显示（演奏模式不需要）

### 3.2 上传交互流程

```
点击「📷 识别图片」
    ├── 弹出选择面板 ──┐
    │                 ├── [选择文件] → 打开文件选择器
    │                 └── [粘贴图片] → 监听粘贴事件
    ↓
显示图片预览（小尺寸缩略图）
    ↓
点击「开始识别」
    ↓
显示识别中状态（加载动画 + "识别中..."）
    ↓
识别完成
    ├── 成功 → 弹出确认对话框：
    │         "识别结果将替换当前编辑器内容，是否继续？"
    │           [替换] [追加到末尾] [取消]
    │            ↓
    │         结果填入编辑器 → 自动触发预览渲染
    │            ↓
    │         显示提示："识别完成，请检查并修正结果"
    │
    └── 失败 → 显示友好提示："无法识别图片中的简谱，请确认图片清晰且为简谱格式"
```

### 3.3 粘贴图片交互

作为快捷方式，用户在编辑器区域内按 `Ctrl/Cmd+V` 粘贴图片时：

```
检测到剪贴板中包含图片
    ↓
编辑器顶部浮出提示条：
"检测到图片，是否识别为简谱？ [识别] [忽略]"
    ↓
点击「识别」→ 进入识别流程（同上）
点击「忽略」→ 提示条消失
5秒无操作 → 提示条自动消失
```

### 3.4 UI 组件设计

#### 识别面板（ImageImportPanel）

```
┌──────────────────────────────────────┐
│  📷 从图片识别简谱                    │
│                                      │
│  ┌────────────────────────────────┐  │
│  │                                │  │
│  │     拖拽图片到此处              │  │
│  │     或 [选择文件]              │  │
│  │                                │  │
│  │     支持 JPG/PNG/WebP          │  │
│  │     最大 10MB                  │  │
│  │                                │  │
│  └────────────────────────────────┘  │
│                                      │
│  [取消]              [开始识别]       │
└──────────────────────────────────────┘
```

#### 识别中状态

```
┌──────────────────────────────────────┐
│  📷 从图片识别简谱                    │
│                                      │
│  ┌────────────────────────────────┐  │
│  │  [图片缩略图]                   │  │
│  └────────────────────────────────┘  │
│                                      │
│         ⏳ 识别中，请稍候...          │
│         ████████░░░░ 60%             │
│                                      │
│  [取消]                              │
└──────────────────────────────────────┘
```

#### 识别结果确认

```
┌──────────────────────────────────────┐
│  ✅ 识别完成                          │
│                                      │
│  以下是识别结果：                      │
│  ┌────────────────────────────────┐  │
│  │  标题: 小星星                    │  │
│  │  调号: C                        │  │
│  │  拍号: 4/4                      │  │
│  │  速度: 120                      │  │
│  │                                │  │
│  │  1 1 5 5 | 6 6 5 - |          │  │
│  │  4 4 3 3 | 2 2 1 - |          │  │
│  │  ...                           │  │
│  └────────────────────────────────┘  │
│                                      │
│  ⚠️ 请在编辑器中检查并修正识别结果     │
│                                      │
│  [取消]    [追加到末尾]  [替换内容]    │
└──────────────────────────────────────┘
```

---

## 四、识别能力范围

### 4.1 可识别的元素（v0.2.0）

| 元素 | 优先级 | 说明 |
|------|--------|------|
| 数字音符 1-7 | P0 | 核心 |
| 休止符 0 | P0 | 核心 |
| 小节线 \| | P0 | 垂直线条 |
| 减时线 / | P0 | 音符下方横线 |
| 延长线 - | P0 | 音符间破折号 |
| 高八度点 · | P1 | 数字上方的点 |
| 低八度点 · | P1 | 数字下方的点 |
| 升号 # | P1 | 数字前 |
| 降号 b/♭ | P1 | 数字前 |
| 标题文字 | P1 | 图片顶部文字 |
| 拍号 4/4 等 | P1 | 标注信息 |
| 调号 1=C 等 | P1 | 标注信息 |

### 4.2 暂不识别的元素

| 元素 | 原因 |
|------|------|
| 圆滑线弧线 | 图片中弧线识别难度极高 |
| 倚音 | 小号装饰音识别精度不足 |
| 波音符号 | 出现频率低，ROI 不高 |
| 歌词 | 超出 MVP 范围 |
| 和弦标记 | 超出 MVP 范围 |

### 4.3 识别准确率预期

| 图片质量 | 预期准确率 | 说明 |
|---------|-----------|------|
| 电子版清晰图片 | 85-95% | 标准排版的印刷简谱 |
| 手机拍照（清晰） | 70-85% | 光线好、角度正 |
| 手机拍照（一般） | 50-70% | 有倾斜、阴影 |
| 手写简谱 | 不支持 | 明确不支持 |

> **关键设计理念**：识别不需要 100% 准确。只要把 80% 的内容自动转化，用户在编辑器中修改 20%，相比全手动输入已经是巨大提升。

---

## 五、技术方案选型（产品视角）

### 方案对比

| 方案 | 优点 | 缺点 | 是否采用 |
|------|------|------|---------|
| **A. 调用云端 LLM 多模态 API** | 开发快、识别准确率高、可理解简谱语义 | 需要网络、有 API 费用、有隐私顾虑 | ⚠️ 推荐主方案 |
| B. 纯前端 OCR (Tesseract.js) | 纯前端、无网络依赖 | 对简谱识别效果差、只能识别文字不理解布局 | ❌ 不推荐 |
| C. 自训练简谱识别模型 | 可高度定制 | 成本极高、需要大量标注数据 | ❌ 不适合当前阶段 |
| D. 前端预处理 + LLM API | 兼顾隐私与准确率 | 中等复杂度 | ✅ 推荐 |

### 推荐方案：D — 前端预处理 + LLM 多模态 API

**核心策略**：
1. 前端做图片预处理（压缩、裁剪），减少传输数据量
2. 调用 LLM 多模态 API（如 OpenAI GPT-4o / Claude）识别简谱内容
3. 后处理：将 LLM 返回结果转换为 hh-jianpu 标准语法
4. **用户自带 API Key**（避免后端成本，保持纯前端架构）

**为什么选 LLM 而不是传统 OCR**：
- 简谱不是纯文字，是文字 + 符号 + 空间位置的组合
- LLM 能理解"上方的点=高八度"、"下方横线=减时线"这种空间语义
- 传统 OCR 只能识别字符，无法理解简谱布局

---

## 六、用户设置

### API Key 管理

在应用设置中（可从顶栏进入），提供 API Key 配置区域：

```
┌──────────────────────────────────────┐
│  ⚙️ 设置                             │
│                                      │
│  图片识别（可选）                      │
│  ─────────────                       │
│  使用 AI 识别简谱图片需要 API Key      │
│                                      │
│  服务商:  [OpenAI ▼]                  │
│  API Key: [sk-••••••••••••]  [测试]   │
│                                      │
│  ℹ️ Key 仅存储在浏览器本地，不会上传    │
│  💡 不配置 Key 也可正常使用其他功能     │
│                                      │
│  [保存]                              │
└──────────────────────────────────────┘
```

**设计决策**：
- Key 存储在 `localStorage`，不传到任何后端
- 不配置 Key 时，「📷 识别图片」按钮显示为禁用状态，hover 提示"需要配置 API Key"
- 支持多家 LLM 服务商（OpenAI / Anthropic / 兼容 API），通过下拉选择
- 提供「测试」按钮验证 Key 是否可用

---

## 七、边界场景处理

| 场景 | 处理方式 |
|------|---------|
| 图片不是简谱 | 提示"未检测到简谱内容，请上传简谱图片" |
| 图片太大（>10MB） | 前端拦截，提示"图片过大，请压缩后重试" |
| 图片太模糊 | LLM 返回低质量结果 → 用户在编辑器中修正 |
| 网络错误 | 提示"网络连接失败，请检查网络后重试" |
| API Key 无效 | 提示"API Key 无效，请检查设置" |
| API 额度耗尽 | 提示"API 调用次数已达上限" |
| 识别耗时过长（>30s） | 自动超时，提示"识别超时，请重试或尝试更清晰的图片" |
| 编辑器已有内容 | 弹出确认：替换 / 追加 / 取消 |
| 只有部分内容可识别 | 尽可能输出已识别内容，不可识别的位置标注 `?` |

---

## 八、对现有功能的影响评估

| 现有功能 | 影响 | 说明 |
|---------|------|------|
| 编辑器输入 | 无影响 | 识别结果只是填入编辑器，后续流程完全复用 |
| 解析器（Parser） | 无影响 | 接收的仍然是文本字符串 |
| 渲染器（Renderer） | 无影响 | 接收的仍然是 Score AST |
| 播放器（Player） | 无影响 | 接收的仍然是 Score AST |
| 示例曲谱 | 无影响 | 并行的输入通道 |
| 帮助文档 | 需更新 | 新增"图片识别"相关说明 |
| 状态管理（Store） | 微调 | 新增 OCR 相关状态字段 |

**核心原则：图片识别只是一个"输入预处理器"，它的输出就是简谱文本。进入编辑器后，所有下游完全复用现有管线。**

---

## 九、成功指标

| 指标 | 目标 |
|------|------|
| 识别一张图片到可编辑状态 | < 15 秒 |
| 清晰电子版简谱识别准确率 | ≥ 85% |
| 用户修正时间（对比手动输入） | 减少 ≥ 60% |
| 功能使用率（在编辑器用户中） | ≥ 20% |
| 对现有功能的回归影响 | 零 |

---

**设计人**: 产品经理  
**审阅人**: 音乐专家、技术架构师  
**下一步**: 技术架构设计 → 开发计划
