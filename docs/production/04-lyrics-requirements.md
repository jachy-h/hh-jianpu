# 歌词功能需求文档

**版本**: v0.2.0  
**创建日期**: 2026年2月8日  
**产品经理**: Jachy  
**需求优先级**: P1

---

## 一、需求背景

### 1.1 用户场景

简谱的核心用户场景之一是**声乐练习**（唱歌、合唱）。目前系统只支持纯音符，用户无法看到歌词，严重影响声乐练习的体验。

**用户痛点**：
- 用户 A（声乐初学者）：练习《小星星》时，只能看到数字，不知道要唱什么词
- 用户 B（合唱团成员）：需要对照简谱练习歌词和旋律的配合
- 用户 C（音乐教师）：教学时需要同时展示音符和歌词

### 1.2 产品目标

1. **让每个音符都能对应到具体的歌词字**
2. **清晰展示字音对应关系**，避免唱错字
3. **支持常见的特殊场景**（一字多音、多字一音、无词音符）
4. **保持语法简洁直觉**，降低学习成本

---

## 二、需求分析

### 2.1 核心需求

#### R1: 基础歌词标注
- 每个汉字对应一个音符
- 歌词紧跟音符下方渲染
- 语法清晰，行首用特殊标记区分歌词行

#### R2: 字音对应规则
- **一字一音**（最常见）：`一 闪 一 闪 亮 晶 晶` → `1 1 5 5 6 6 5 -`
- **一字多音**（拖长音）：`星` → `5 -` （"星"字拖两拍）
- **多字一音**（快速念）：`的星` → `1` （两个字在一拍内念完）
- **无词音符**（间奏、前奏）：某些音符不对应歌词

#### R3: 跨小节歌词
- 歌词可以跨越小节线
- 小节线不影响字音对应关系

### 2.2 边界场景

| 场景 | 示例 | 处理方式 |
|------|------|---------|
| 休止符对应歌词 | `0 0 1 2` + `[空] [空] 一 闪` | 休止符位置留空或用 `_` |
| 帚音/装饰音对应歌词 | `^3/ 1 2` + `[空] 一 闪` | 装饰音不占歌词（或共享主音歌词） |
| 延长线对应歌词 | `1 - - -` + `星` | 延长线不独占歌词 |
| 一行多段歌词 | 同一旋律多段词 | v0.2.0 不支持，后续扩展 |

### 2.3 非功能性需求

- **语法直觉性**：学习成本 < 5分钟
- **错误容忍性**：歌词数量与音符不匹配时给出友好提示
- **渲染美观性**：字与音符对齐，不遮挡其他元素
- **性能**：不影响现有渲染性能

---

## 三、语法设计

### 3.1 基础语法

#### 歌词行标记
```
C 歌词内容
```
- 行首 `C` 标记该行为歌词行（C = Chinese lyrics）
- 空格后为歌词内容
- 歌词按顺序与音符行对应

#### 旋律行标记（可选）
```
P 音符序列
```
- 行首 `P` 标记该行为旋律行（P = Pitches）
- 提高可读性，但不强制要求

#### 最简示例
```
标题: 小星星
调号: C
拍号: 4/4
速度: 120

P 1 1 5 5 | 6 6 5 - |
C 一 闪 一 闪 亮 晶 晶 _
```

### 3.2 字音对应规则

#### 规则 1: 一字一音（默认）
```
P 1 2 3 4
C 一 二 三 四
```
每个音符对应一个汉字，用空格分隔。

#### 规则 2: 多字一音（使用括号）
```
P 1 2 3 4
C (我的) 祖 国 心
```
使用 `(多字)` 将多个字符组合到一个音符。
1 - - - | 2 3 4
@ 星- - - 真 美 丽
```
- 延长线对应的位置写 `-`
- 表示该字持续到延长线结束

**简化写法**（可选）：
```
1 - - - | 2 3 4
@ 星 真 美 丽
```
解析器自动识别：一个字对应多个音符时，视为拖长音。

#### 规则 3: 多字一音（使用 `()` 分组）
```
1 2 3 4
@ (我的) 祖 国 啊
```
- `(我的)` 表示两个字在一拍内快速念完
- 对应一个音符

#### 规则 4: 无词音符（使用 `_` 占位）
```
1 2 0 0 | 3 4 5
@ 一 二 _ _ 真 美 丽
```
- `_` 表示该音符无对应歌词
- 常用于休止符、前奏、间奏

#### 规则 5: 倚音/装饰音（不占歌词）
```
^3/ 1 2 3
@ 一 闪 一
```
- 帚音 `^3/` 不消耗歌词
- 三个字对应三个主音符

### 3.3 完整示例

```
标题: 小星星
调号: C
拍号: 4/4
速度: 120

1 1 5 5 | 6 6 5 - |
@ 一 闪 一 闪 亮 晶 晶

4 4 3 3 | 2 2 1 - |
@ 满 天 都 是 小 星 星

5 5 4 4 | 3 3 2 - |
@ 挂 在 天 上 放 光 明
```

### 3.4 复杂示例

```
标题: 生日快乐
调号: C
拍号: 3/4
速度: 100

0 5/ 5/ 6 | 5 '1 7 |
@ _ (祝你) 生 日 快 乐

5/ 5/ 6 5 | '2 '1 - |
@ (祝你) 生 日 快 乐
```

---

## 四、渲染规则

### 4.1 视觉呈现

```
┌────────────────────────────────┐
│  1   1   5   5 | 6   6   5  -  │  ← 音符行
│  一  闪  一  闪  亮  晶  晶      │  ← 歌词行
└────────────────────────────────┘
```

**设计要点**：
- 歌词位于音符正下方，居中对齐
- 歌词字号略小于音符（约 0.9 倍）
- 歌词与音符保持适当间距（约 10px）
- 多字一音的分组用小号字体紧凑显示

### 4.2 对齐规则

- **横向对齐**：每个字对齐到对应音符的中心
- **纵向间距**：音符底部到歌词顶部 10px
- **小节线处理**：小节线不影响歌词排版
- **换行处理**：歌词跟随音符行自动换行

---

## 五、错误处理

### 5.1 数量不匹配

**场景**：歌词数量与有效音符数量不一致

```
1 2 3 4
@ 一 二 三
```

**处理**：
- 给出警告："歌词数量(3)与音符数量(4)不匹配"
- 仍然渲染已匹配的部分
- 多余的音符或歌词用不同颜色标注

### 5.2 语法错误

**场景**：`@` 标记位置错误

```
1 2 3 @ 一 二 三  # 错误：@ 不在行首
```

**处理**：
- 给出错误提示："歌词标记 @ 必须在行首"
- 该行不解析为歌词

### 5.3 未闭合分组

**场景**：`(` 没有对应的 `)`

```
@ (我的 祖国
```

**处理**：
- 警告："未闭合的分组符号"
- 视为普通文本处理

---

## 六、实施计划

### Phase 1: 核心功能（本次实施）
- [x] 需求文档编写
- [ ] 功能设计文档
- [ ] Types 扩展（Lyrics 类型定义）
- [ ] Tokenizer 扩展（识别 `@` 行）
- [ ] Parser 扩展（解析歌词与音符对应）
- [ ] Renderer 扩展（渲染歌词到 SVG）
- [ ] 单元测试（解析 + 渲染）
- [ ] 示例更新（小星星、生日快乐加歌词）

### Phase 2: 高级功能（后续）
- [ ] 多段歌词支持
- [ ] 歌词高亮跟随播放
- [ ] 拼音/罗马音支持
- [ ] 歌词编辑器优化

---

## 七、验收标准

### 功能验收
- ✅ 支持 `@` 标记歌词行
- ✅ 正确解析一字一音、一字多音、多字一音
- ✅ 正确处理 `_` 占位和 `()` 分组
- ✅ 倚音/装饰音不消耗歌词
- ✅ 歌词与音符正确对齐渲染
- ✅ 数量不匹配时给出友好提示

### 体验验收
- ✅ 语法学习成本 < 5 分钟
- ✅ 小星星示例有完整歌词
- ✅ 歌词字体清晰可读
- ✅ 不影响无歌词曲谱的使用

### 性能验收
- ✅ 带歌词的曲谱渲染时间增加 < 10%
- ✅ 单元测试覆盖率 ≥ 90%

---

**需求负责人**: Jachy  
**审阅人**: 音乐专家、技术架构师  
**下一步**: 功能设计文档
