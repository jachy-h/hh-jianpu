# 用户反馈实施方案

**反馈来源**: 用户  
**日期**: 2026年2月8日  
**需求**: 1) 三连音简化语法  2) 节拍验证

---

## 一、需求理解

### 需求 1: 三连音简化语法

**原设计**: 使用特殊符号 `{3 1 2 3}` 标记三连音  
**新需求**: 三个连续音符（无空格）自动识别为三连音

```
# 示例
123    → 三连音（每个音符 2/3 时值）
1 2 3  → 三个正常四分音符
```

### 需求 2: 节拍验证

检查每小节的音符总时值是否符合拍号，不符合时给出警告。

```
# 示例
标题: 测试
拍号: 4/4

1 2 3 4 5 | ...  # 警告：第1小节 5 拍，超出 4/4 拍的 4 拍
```

---

## 二、可行性评估

### 需求 1 可行性分析

#### ✅ 优点
- 符合直觉：三个挨着的音符就是三连音
- 无需额外符号，降低学习成本

#### ⚠️ 挑战与冲突

**与现有 Beam 功能冲突**：
- 当前系统中，连续无空格的音符会被分配到同一个 `beamGroup`（用于渲染连音线）
- 如果 `123` 自动变三连音，那 `1_2_3_`（三个八分音符）也会被误识别

**歧义场景**：
```
# 用户想表达什么？
1234       → 四连音？还是 1+2+34（两个音符+一个三连音）？
12         → 二连音？
12345      → 五连音？
```

#### 🎯 折衷方案（推荐）

**方案 A**：引入简单的分组符号，但比 `{3 1 2 3}` 更简洁
```
(123)   → 三连音
(12345) → 五连音
123     → 保持现有行为（三个正常音符，如果无空格会有连音线）
```

**方案 B**：完全采纳用户建议，但增加约束
- 只有恰好 3 个连续音符（且都是相同基础时值）才识别为三连音
- 2个、4个、5个等不自动识别，保持现有行为
- 用户如需其他连音需用符号标记

#### 🚨 风险

采纳完全自动识别会导致：
1. **破坏性变更**：现有用户写的 `123` 会突然变成三连音
2. **歧义增加**：用户无法明确表达意图（到底要不要三连音）
3. **扩展性差**：二连音、五连音、七连音无法统一处理

---

### 需求 2 可行性分析

#### ✅ 优点
- 帮助初学者发现节拍错误
- 实现成本低
- 不影响现有功能（只是新增警告）

#### 实现要点

1. 在 `parseBody` 完成后，遍历每个小节
2. 计算每个小节的总时值（以"拍"为单位）
3. 与拍号的 `beats` 字段对比
4. 不符合则加入 `errors` 数组（类型改为 `warnings`？）

#### 计算规则

```typescript
// 计算音符时值（以"拍"为单位）
function calculateBeats(note: NoteElement, beatValue: number): number {
  if (note.type === 'breath') return 0;
  
  const { base, dots } = note.duration;
  let beats = beatValue / base; // 4/4 拍中，四分音符 = 1 拍
  
  // 附点延长 50%
  if (dots > 0) {
    beats *= (1 + 0.5 * dots);
  }
  
  // 倚音不占独立时间
  if (note.type === 'note' && note.isGrace) {
    return 0;
  }
  
  return beats;
}
```

---

## 三、实施方案

### 推荐实施优先级

| 功能 | 优先级 | 工时 | 理由 |
|------|--------|------|------|
| **节拍验证** | P0 | 0.5天 | 实现简单、价值高、无冲突 |
| **三连音（方案A）** | P1 | 1天 | 需要新符号，需用户适应 |
| 三连音（方案B自动识别） | ❌不推荐 | - | 歧义大、破坏性变更 |

---

## 四、建议与用户沟通

### 关于三连音的建议

**问题**：完全自动识别三连音存在歧义和破坏性变更风险。

**建议方案 A**：使用简洁的分组符号
```
# 新语法
(123)   → 三连音
(12)    → 二连音
(12345) → 五连音

# 优点
- 意图明确，无歧义
- 扩展性好（支持任意连音）
- 不破坏现有行为
```

**建议方案 B**（如果坚持无符号）：严格限制条件
- 只有恰好3个连续音符才识别为三连音
- 必须是相同基础时值（如都是四分音符）
- 其他情况保持现有行为

**请用户确认**：
1. 是否接受方案 A（使用括号）？
2. 还是坚持完全自动识别（我们会处理歧义和风险）？

---

## 五、先实施节拍验证（立即可做）

由于节拍验证无歧义且价值高，建议先实施这个功能。三连音等用户确认方案后再实施。
