# 更新日志 (CHANGELOG)

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- 🎵 **倚音（Grace Note）功能** - 使用 `^` 前缀标记装饰音
  - **语法**: `^4 5`（4是5的倚音，显示在5的左上角）
  - **视觉**: 小号字体，位于主音符左上方
  - **时值**: **不占用独立的节拍时间**，从主音符中“借用”（符合专业乐理）
  - **播放**: 倚音在主音符之前极短时间（~50ms）发声
  - **特性**:
    - 支持八度标记：`^'1 2` `^.7 1`
    - 支持升降号：`^#4 5` `^b7 1`
    - 支持连续倚音：`^3^4 5`
  - **实现**:
    - Tokenizer: 识别 `^` 为 GRACE_PREFIX token
    - Types: Note 接口添加 isGrace 字段
    - Parser: 解析倚音并标记
    - Layout: 倚音使用主音符的坐标位置
    - Player: 倚音不占独立时间，在主音符前 50ms 发声
    - UI: 渲染为小号字体（字号12px，透明度70%，左上偏移）
  - **测试**: 新增倚音解析测试
  - **示例**: 更新“倚音示例”曲谱以符合拍号

- 🎵 **换气记号（Breath Mark）** - 使用 `v` 或 `V` 标记换气位置
  - **语法**: `1 2 3 4 | 5 v 6 7`
  - **用途**: 标记演唱或管乐演奏时的换气位置
  - **特性**: 
    - 不占用时间，仅作为视觉标记
    - 支持大小写 `v` 或 `V`
    - 可以放置在小节内任意位置
  - **实现**:
    - Tokenizer: 识别 `v`/`V` 为 BREATH token
    - Types: 新增 Breath 接口
    - Parser: 解析换气符号到 AST
    - Player: 换气符号不参与时间计算
    - UI: 渲染为 v 形标记
  - **测试**: 新增换气符号解析测试
  - **示例**: 新增"换气记号示例"曲谱

### Fixed
- 🐛 **修复多个八度标记** - 支持高两个八度（`''1`）和低两个八度（`..1`）
  - **问题**: tokenizer 只检查下一个字符是否为数字，导致连续的 `'` 或 `.` 无法被识别
  - **修复**: 改为向后查找所有连续的相同符号，然后检查最终字符是否为数字
  - **支持范围**: 
    - `''1` `'''1` 等多个高八度
    - `..1` `...1` 等多个低八度
  - **测试**: 新增测试用例验证 -2 到 +2 八度范围
  - **示例**: 新增"八度示例"曲谱展示完整音域

### Changed
- 🎵 **高音符号统一为前缀** - 与低音符号保持一致
  - **旧语法**: `1'` `2'` `3'` (后缀)
  - **新语法**: `'1` `'2` `'3` (前缀)
  - **理由**: 低音符号 `.` 是前缀（`.7` `.6`），高音符号 `'` 也统一为前缀，保持语法一致性
  - **影响范围**:
    - Tokenizer: 单引号检测改为前瞻模式（检查下一个字符是否为数字）
    - Parser: 高八度标记从后置修饰符移到前置修饰符处理
    - 所有示例曲谱和文档已更新
  - **迁移指南**: 将所有 `1'` 改为 `'1`，`2'` 改为 `'2`，以此类推

### Added
- 🎵 **圆滑线（Slur）功能** - 使用小括号标记连贯演奏
  - **语法**: `(1 2 3)` - 用圆滑线连接音符
  - **跨小节**: `(1 2 | 3 4)` - 支持跨越小节线
  - **视觉效果**: SVG 二次贝塞尔曲线，向上弯曲的弧线
  - **动态高亮**: 播放时圆滑线根据音符状态变色（活动/已播放）
  - **架构实现**:
    - Tokenizer: 新增 `SLUR_START` `(` 和 `SLUR_END` `)` token 类型
    - Parser: 新增 `assignSlurGroups()` 函数识别括号内音符
    - Renderer: 传递 `slurGroup` 字段到 UI 层
    - UI: ScoreView 组件使用 `<path>` 元素渲染弧线
  - **测试覆盖**: 新增 3 个单元测试（单小节、跨小节、多组圆滑线）
  - **文档更新**:
    - `docs/user-guide/notation-syntax.md`: 更新第 10 节，详细说明三种连线区别
    - `apps/web/src/components/HelpModal/HelpModal.tsx`: 更新第 8 节，添加圆滑线表格
    - 新增示例: "圆滑线示例" - 展示各种圆滑线用法

- 📖 **简谱源码编写说明文档** - 详细的语法规则和示例
  - 完整的元信息、音符、高低八度、变音记号说明
  - 时值（减时线、延长线）、休止符、小节线规则
  - 连音线（Beam）和圆滑线（Slur）详细对比
  - 实用示例和常见问题解答
  - 学习路径和调试技巧
  - 文档位置：`docs/user-guide/notation-syntax.md`

- 🔍 **帮助模态框** - 在页面上查看编写说明
  - 点击顶部栏的「❓ 帮助」按钮打开
  - 响应式设计，支持桌面和移动设备
  - 包含完整的语法规则、示例和常见问题
  - 快速查找功能，方便学习

- 🔧 **可拖动分隔线** - 编辑模式下调整布局
  - 编辑器和预览面板之间可拖动调整宽度
  - 平滑的拖动体验，带视觉反馈
  - 悬停时显示蓝色提示线
  - 拖动时全屏高亮
  - 自动限制最小宽度（300px），防止面板过小
  - 支持桌面设备（移动设备保持原有响应式布局）

### Changed
- 🎨 **编辑器布局优化**
  - 从固定 50/50 分割改为可自定义宽度
  - 提升用户自定义体验

### Tests
- ✅ **所有测试通过**: 25/25 单元测试
  - Parser: 10 个测试（新增 3 个圆滑线测试）
  - Player: 11 个测试
  - Renderer: 4 个测试

---

## [0.1.0] - 2026-02-07

### Added
- ✨ **核心功能**
  - 简谱文本解析器（Parser）
  - SVG 渲染器（Renderer）
  - 音频播放器（Player with Tone.js）
  
- 🎼 **编辑功能**
  - 实时简谱编辑器
  - 语法错误提示
  - 300ms 防抖优化
  
- ▶️ **播放功能**
  - 音符高亮跟随
  - 速度调节（40-240 BPM）
  - 播放控制（播放/暂停/停止）
  
- 🎨 **用户界面**
  - 双模式切换（编辑/演奏）
  - 响应式布局
  - 极简设计风格
  - 三首示例曲谱
  
- 📚 **文档**
  - 用户需求分析文档
  - 产品设计文档
  - 技术架构文档
  - 测试报告（功能测试、单元测试、最终交付）
  - 开发总结文档
  
- 🧪 **测试**
  - 19 个单元测试（100% 通过）
  - Parser、Renderer、Player 全覆盖
  - 生产构建验证

### Fixed
- 🐛 Parser REST token 未添加到 currentNotes 数组
- 🐛 TypeScript NodeJS.Timeout 浏览器兼容性问题
- 🐛 高低八度识别逻辑错误
- 🐛 测试文件模块解析失败

### Technical
- 📦 **技术栈**
  - TypeScript 5.4.0
  - React 18.3.0
  - Vite 5.4.21
  - Zustand 4.5.0
  - Tone.js 15.0.4
  - Tailwind CSS 3.4.0
  - Vitest 2.1.9
  
- 🏗️ **架构**
  - Monorepo with pnpm workspace
  - Core library + Web application
  - 打包体积：135KB (gzipped)

---

## 版本说明

### v0.1.0 - MVP (Minimum Viable Product)
首个可用版本，包含基础的编辑、渲染和播放功能。

### Unreleased - 增强体验
- 添加用户帮助文档和界面交互优化
- 提升编辑器使用体验

---

## 即将到来

### v0.1.1 - Bug 修复与打磨
- [ ] 移动端真机测试
- [ ] 细节优化
- [ ] 性能监控

### v0.2.0 - 编辑体验升级
- [ ] CodeMirror 6 集成
- [ ] 语法高亮
- [ ] 错误波浪线
- [ ] 本地存储

### v0.3.0 - 高级功能
- [ ] 选段循环播放
- [ ] 变调（移调）功能
- [ ] 导出图片/PDF
- [ ] 打印友好样式

---

**日期格式**: YYYY-MM-DD  
**版本标签**: [版本号] - YYYY-MM-DD
