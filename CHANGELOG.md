# 更新日志 (CHANGELOG)

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

## [0.3.1] - 2026-03-01

### Added
- ⌨️ **键盘快捷键** - 演奏模式下按空格键控制播放/暂停
  - 播放/暂停后焦点自动设置到播放按钮
  - 避免误触输入框

### Fixed
- 🎵 **播放暂停后继续播放** - 修复暂停后点击播放从头开始的问题
  - 检测 paused 状态，从中断位置继续播放
  - 保持当前播放进度

## [0.3.0] - 2026-03-01

### Added
- 🚀 **Release Skill** - Automated version release process
  - New TypeScript release script: `scripts/release.ts`
  - Skill documentation: `.qwen/skills/release/SKILL.md`
  - Supports patch, minor, and major version bumps
  - Interactive confirmation before publishing
  - Automatic CHANGELOG updates
  - Runs tests and build before committing
  - Creates git commit and tag automatically

### Changed
- Updated version to 0.3.0 across all packages:
  - Root `package.json`: 0.2.0 → 0.3.0
  - `packages/core/package.json`: 0.2.0 → 0.3.0
  - `apps/web/package.json`: 0.2.0 → 0.3.0

## [0.2.0] - 2026-02-27

## [0.2.0] - 2026-02-27

### Added
- 📷 **图片识别转简谱功能** - 使用 AI 从图片中识别简谱并转换为可编辑文本
  - **核心能力**：
    - 支持上传本地图片（JPG/PNG/WebP，最大10MB）
    - 支持拖拽上传和粘贴图片
    - 自动识别简谱数字、符号、元信息（标题、调号、拍号、速度）
    - 可选替换或追加到编辑器
  - **LLM 支持**：
    - OpenAI (GPT-4o)
    - Anthropic (Claude 3.5 Sonnet)
    - 兼容 OpenAI API 格式的第三方服务
  - **安全设计**：
    - API Key 仅存储在浏览器本地（localStorage）
    - 图片直接从浏览器发送到 LLM 服务商，无中间服务器
    - 不配置 Key 不影响其他功能正常使用
  - **UI 组件**：
    - 设置面板（⚙️）：配置 LLM 服务商和 API Key
    - 图片识别按钮（📷）：仅在编辑模式下显示
    - 识别面板：拖拽/选择图片 → 预览 → 识别 → 结果展示
  - **技术架构**：
    - 前端预处理：图片压缩、格式转换（最大2048px）
    - LLM 识别：超时控制（30秒）、错误处理
    - 后处理：清洗 LLM 输出、语法验证
  - **体验优化**：
    - 进度提示（预处理 → 识别 → 整理结果）
    - 友好错误提示（网络错误、API Key 无效、识别失败等）
    - 识别结果预览和警告提示
  - **文档**：
    - 产品设计文档（功能边界、交互设计、识别能力）
    - 架构设计文档（模块设计、数据流、类型定义）
    - 开发 TODO（24个任务，7天工时估算）

### Changed
- 扩展状态管理（useStore）：新增 OCR 相关状态（ocrStatus, ocrResult, ocrError）和方法
- AppLayout：新增设置按钮和图片识别入口

### Technical
- 新增目录结构：
  - `apps/web/src/services/ocr/` - OCR 服务层
  - `apps/web/src/components/Settings/` - 设置组件
  - `apps/web/src/components/ImageImport/` - 图片导入组件
- 零依赖：纯浏览器 API（Canvas、File、fetch）
- 零回归：所有 45 个测试通过

## [0.1.2] - 2026-02-08

### Added
- 🎵 **歌词（Lyrics）功能** - 支持在简谱下方添加歌词
  - **语法**：
    - 旋律行标记：`P 音符序列`（Pitches，可选）
    - 歌词行标记：`C 歌词内容`（Chinese lyrics）
    - 基本语法：`C 一 闪 一 闪` - 一字对一音
    - 多字分组：`C (我的) 祖 国` - 括号内多字对应一个音符
    - 占位符：`C 星 _ _ 光` - 使用 `_` 跳过音符
  - **视觉**：歌词显示在对应音符下方，支持播放时高亮
  - **验证**：自动检测歌词数量与有效音符数量是否匹配
  - **规则**：
    - 休止符、延长线、换气记号不分配歌词
    - 倚音（装饰音）不分配歌词
    - 多行歌词自动合并
  - **测试**：8个单元测试覆盖所有场景
  - **文档**：完整的语法说明和示例（用户指南 + 帮助模态框）
  - **示例**：小星星和生日快乐歌添加歌词

## [0.1.1] - 2026-02-08

### Added
- 🎵 **波音（Trill）功能** - 使用 `~` 前缀标记快速颤音装饰
  - **语法**: 
    - 单波音（上波音）：`~5` - 主音与上方音快速交替
    - 复波音（双波音）：`~~5` - 更复杂的交替模式
    - 下波音：`~.5` - 主音与下方音快速交替
  - **视觉**: 波浪符号显示在音符上方
    - 单波音：单个波浪 ～
    - 复波音：双波浪 ～～
    - 下波音：波浪 + 垂直线穿过中心
  - **播放**: 
    - 单波音：主音→上方邻音→主音（各50ms）
    - 复波音：4个音符快速交替（各50ms）
    - 下波音：主音→下方邻音→主音（各50ms）
  - **特性**:
    - 支持与其他修饰符组合：`~#4` `~b7`
    - 波音不占用额外时间，从主音符中借用
  - **实现**:
    - Tokenizer: 新增 TRILL token 类型识别 `~`
    - Types: Note 接口添加 trillType 字段
    - Parser: 向前扫描检测波音标记和点号组合
    - Player: 插入快速邻音，计算正确的频率
    - UI: 使用 SVG path 渲染波浪符号
  - **测试**: 新增波音解析和播放测试
  - **示例**: 新增"波音示例"曲谱

### Fixed
- 🐛 **修复八度标记语法** - 统一为后缀形式，解决下波音冲突
  - **问题**: 
    - 原设计 `.` 和 `'` 可以作为前缀（`.7` `'1`）或后缀（`7.` `1'`）
    - 导致 `~.5` 被误解析为"单波音 + 低八度5"而非"下波音5"
  - **修复**: 
    - **新规则**：`.` 和 `'` **只能作为后缀**出现在数字后面
    - `5.` ✅ 低八度5，`5'` ✅ 高八度5
    - `.5` ❌ 无效，`'5` ❌ 无效
  - **实现**:
    - Tokenizer: 修改 `.` 和 `'` 检测逻辑，只在前一个字符是数字时生成 OCTAVE_DOWN/UP token
    - Parser.parseNote(): 从 NOTE **后面**读取八度标记，而非前面
  - **影响**: 
    - 所有示例和测试已更新为新语法
    - 文档已更新说明后缀用法
  - **测试**: 验证 `~.5` 正确解析为下波音

### Added
- 🎵 **倚音（Grace Note）功能** - 使用 `^` 前缀标记装饰音
  - **语法**: 
    - 长倚音：`^4 5`（4是5的倚音，显示在5的左上角，无下划线）
    - 短倚音：`^4_ 5`（4_是5的倚音，显示在5的左上角，带单下划线）
  - **视觉**: 小号字体，位于主音符左上方
    - 长倚音：无下划线
    - 短倚音：单下划线
  - **时值**: **不占用独立的节拍时间**，从主音符中“借用”（符合专业乐理）
  - **播放**: 
    - 长倚音：在主音符前 ~60ms 发声
    - 短倚音：在主音符前 ~30ms 发声（更快）
  - **特性**:
    - 支持八度标记：`^'1 2` `^.7_ 1`
    - 支持升降号：`^#4_ 5` `^b7 1`
    - 支持连续倚音：`^3^4_ 5`
  - **实现**:
    - Types: Note 接口添加 isGrace 和 graceType 字段
    - Parser: 解析倚音并检测下划线判断类型
    - Layout: 倚音使用主音符的坐标位置
    - Player: 倚音不占独立时间，短倚音更快（30ms vs 60ms）
    - UI: 渲染为小号字体，短倚音显示单下划线
  - **测试**: 新增倚音解析测试
  - **示例**: 更新“倚音示例”曲谱以符合拍号

- 🎵 **换气记号（Breath Mark）** - 使用 `v` 或 `V` 标记换气位置
  - **语法**: `1 2 3 4 | 5 v 6 7`
  - **用途**: 标记演唱或管乐演奏时的换气位置
  - **特性**: 
    - 不占用时间，仅作为视觉标记
    - 支持大小写 `v` 或 `V`
    - 可以放置在小节内任意位置
  - **实现**:
    - Tokenizer: 识别 `v`/`V` 为 BREATH token
    - Types: 新增 Breath 接口
    - Parser: 解析换气符号到 AST
    - Player: 换气符号不参与时间计算
    - UI: 渲染为 v 形标记
  - **测试**: 新增换气符号解析测试
  - **示例**: 新增"换气记号示例"曲谱

### Fixed
- 🐛 **修复多个八度标记** - 支持高两个八度（`''1`）和低两个八度（`..1`）
  - **问题**: tokenizer 只检查下一个字符是否为数字，导致连续的 `'` 或 `.` 无法被识别
  - **修复**: 改为向后查找所有连续的相同符号，然后检查最终字符是否为数字
  - **支持范围**: 
    - `''1` `'''1` 等多个高八度
    - `..1` `...1` 等多个低八度
  - **测试**: 新增测试用例验证 -2 到 +2 八度范围
  - **示例**: 新增"八度示例"曲谱展示完整音域

### Changed
- 🎵 **高音符号统一为前缀** - 与低音符号保持一致
  - **旧语法**: `1'` `2'` `3'` (后缀)
  - **新语法**: `'1` `'2` `'3` (前缀)
  - **理由**: 低音符号 `.` 是前缀（`.7` `.6`），高音符号 `'` 也统一为前缀，保持语法一致性
  - **影响范围**:
    - Tokenizer: 单引号检测改为前瞻模式（检查下一个字符是否为数字）
    - Parser: 高八度标记从后置修饰符移到前置修饰符处理
    - 所有示例曲谱和文档已更新
  - **迁移指南**: 将所有 `1'` 改为 `'1`，`2'` 改为 `'2`，以此类推

### Added
- 🎵 **圆滑线（Slur）功能** - 使用小括号标记连贯演奏
  - **语法**: `(1 2 3)` - 用圆滑线连接音符
  - **跨小节**: `(1 2 | 3 4)` - 支持跨越小节线
  - **视觉效果**: SVG 二次贝塞尔曲线，向上弯曲的弧线
  - **动态高亮**: 播放时圆滑线根据音符状态变色（活动/已播放）
  - **架构实现**:
    - Tokenizer: 新增 `SLUR_START` `(` 和 `SLUR_END` `)` token 类型
    - Parser: 新增 `assignSlurGroups()` 函数识别括号内音符
    - Renderer: 传递 `slurGroup` 字段到 UI 层
    - UI: ScoreView 组件使用 `<path>` 元素渲染弧线
  - **测试覆盖**: 新增 3 个单元测试（单小节、跨小节、多组圆滑线）
  - **文档更新**:
    - `docs/user-guide/notation-syntax.md`: 更新第 10 节，详细说明三种连线区别
    - `apps/web/src/components/HelpModal/HelpModal.tsx`: 更新第 8 节，添加圆滑线表格
    - 新增示例: "圆滑线示例" - 展示各种圆滑线用法

- 📖 **简谱源码编写说明文档** - 详细的语法规则和示例
  - 完整的元信息、音符、高低八度、变音记号说明
  - 时值（减时线、延长线）、休止符、小节线规则
  - 连音线（Beam）和圆滑线（Slur）详细对比
  - 实用示例和常见问题解答
  - 学习路径和调试技巧
  - 文档位置：`docs/user-guide/notation-syntax.md`

- 🔍 **帮助模态框** - 在页面上查看编写说明
  - 点击顶部栏的「❓ 帮助」按钮打开
  - 响应式设计，支持桌面和移动设备
  - 包含完整的语法规则、示例和常见问题
  - 快速查找功能，方便学习

- 🔧 **可拖动分隔线** - 编辑模式下调整布局
  - 编辑器和预览面板之间可拖动调整宽度
  - 平滑的拖动体验，带视觉反馈
  - 悬停时显示蓝色提示线
  - 拖动时全屏高亮
  - 自动限制最小宽度（300px），防止面板过小
  - 支持桌面设备（移动设备保持原有响应式布局）

### Changed
- 🎨 **编辑器布局优化**
  - 从固定 50/50 分割改为可自定义宽度
  - 提升用户自定义体验

### Tests
- ✅ **所有测试通过**: 25/25 单元测试
  - Parser: 10 个测试（新增 3 个圆滑线测试）
  - Player: 11 个测试
  - Renderer: 4 个测试

---

## [0.1.0] - 2026-02-07

### Added
- ✨ **核心功能**
  - 简谱文本解析器（Parser）
  - SVG 渲染器（Renderer）
  - 音频播放器（Player with Tone.js）
  
- 🎼 **编辑功能**
  - 实时简谱编辑器
  - 语法错误提示
  - 300ms 防抖优化
  
- ▶️ **播放功能**
  - 音符高亮跟随
  - 速度调节（40-240 BPM）
  - 播放控制（播放/暂停/停止）
  
- 🎨 **用户界面**
  - 双模式切换（编辑/演奏）
  - 响应式布局
  - 极简设计风格
  - 三首示例曲谱
  
- 📚 **文档**
  - 用户需求分析文档
  - 产品设计文档
  - 技术架构文档
  - 测试报告（功能测试、单元测试、最终交付）
  - 开发总结文档
  
- 🧪 **测试**
  - 19 个单元测试（100% 通过）
  - Parser、Renderer、Player 全覆盖
  - 生产构建验证

### Fixed
- 🐛 Parser REST token 未添加到 currentNotes 数组
- 🐛 TypeScript NodeJS.Timeout 浏览器兼容性问题
- 🐛 高低八度识别逻辑错误
- 🐛 测试文件模块解析失败

### Technical
- 📦 **技术栈**
  - TypeScript 5.4.0
  - React 18.3.0
  - Vite 5.4.21
  - Zustand 4.5.0
  - Tone.js 15.0.4
  - Tailwind CSS 3.4.0
  - Vitest 2.1.9
  
- 🏗️ **架构**
  - Monorepo with pnpm workspace
  - Core library + Web application
  - 打包体积：135KB (gzipped)

---

## 版本说明

### v0.1.0 - MVP (Minimum Viable Product)
首个可用版本，包含基础的编辑、渲染和播放功能。

### Unreleased - 增强体验
- 添加用户帮助文档和界面交互优化
- 提升编辑器使用体验

---

## 即将到来

### v0.1.1 - Bug 修复与打磨
- [ ] 移动端真机测试
- [ ] 细节优化
- [ ] 性能监控

### v0.2.0 - 编辑体验升级
- [ ] CodeMirror 6 集成
- [ ] 语法高亮
- [ ] 错误波浪线
- [ ] 本地存储

### v0.3.0 - 高级功能
- [ ] 选段循环播放
- [ ] 变调（移调）功能
- [ ] 导出图片/PDF
- [ ] 打印友好样式

---

**日期格式**: YYYY-MM-DD  
**版本标签**: [版本号] - YYYY-MM-DD
